# WeatherAI Analytics Data Model

Version: 1.0  
Date: 2025-08-23  
Status: Phase 1 Implementation

---

## Overview

The WeatherAI analytics platform introduces a normalized data model designed for weather analytics, trend analysis, and forecast accuracy assessment. This Phase 1 implementation establishes the foundation for future advanced analytics features.

## Core Philosophy

- **Star-ish Schema**: Fact tables (observations, forecasts) linked to dimension tables (locations)
- **Temporal Focus**: All data is time-series oriented with proper indexing
- **Accuracy Tracking**: Built-in forecast verification and error metrics
- **Aggregation-Friendly**: Pre-computed daily summaries for performance
- **Audit Trail**: Complete query and computation tracking

---

## Table Descriptions

### ObservationHourly
**Purpose**: Store hourly weather observations from external sources

| Column | Type | Description |
|--------|------|-------------|
| id | Integer | Primary key |
| location_id | Integer | FK to locations table |
| observed_at | DateTime | UTC timestamp of observation |
| temp_c | Float | Temperature in Celsius |
| wind_kph | Float | Wind speed in km/h |
| precip_mm | Float | Precipitation in millimeters |
| humidity_pct | Float | Relative humidity percentage |
| condition_code | String | Weather condition code |
| source | String | Data provider (e.g., "open-meteo") |
| raw_json | Text | Original JSON for debugging |

**Indexes**: 
- `ix_observation_hourly_location_time` on (location_id, observed_at)

**Retention**: TODO - Implement partitioning for long-term data

---

### ForecastHourly
**Purpose**: Store normalized hourly forecast data from weather providers

| Column | Type | Description |
|--------|------|-------------|
| id | Integer | Primary key |
| location_id | Integer | FK to locations table |
| forecast_issue_time | DateTime | When forecast was issued |
| target_time | DateTime | Time being forecasted |
| temp_c | Float | Forecasted temperature in Celsius |
| precipitation_probability_pct | Float | Chance of precipitation (0-100) |
| wind_kph | Float | Forecasted wind speed in km/h |
| model_name | String | Weather model identifier |
| source_run_id | String | Provider's model run ID |
| raw_json | Text | Original JSON for debugging |

**Indexes**: 
- `ix_forecast_hourly_location_target` on (location_id, target_time)

**Usage**: Ingested from ForecastCache during processing

---

### AggregationDaily
**Purpose**: Pre-computed daily weather summaries for performance

| Column | Type | Description |
|--------|------|-------------|
| id | Integer | Primary key |
| location_id | Integer | FK to locations table |
| date | DateTime | Date (midnight UTC) |
| temp_min_c | Float | Daily minimum temperature |
| temp_max_c | Float | Daily maximum temperature |
| avg_temp_c | Float | Daily average temperature |
| total_precip_mm | Float | Total daily precipitation |
| max_wind_kph | Float | Maximum daily wind speed |
| heating_degree_days | Float | Heating degree days (base 18°C) |
| cooling_degree_days | Float | Cooling degree days (base 18°C) |
| generated_at | DateTime | When aggregation was computed |

**Indexes**: 
- `ix_aggregation_daily_location_date` on (location_id, date)

**Computation**: Generated from ObservationHourly data via AggregationService

---

### ForecastAccuracy
**Purpose**: Track forecast performance vs actual observations

| Column | Type | Description |
|--------|------|-------------|
| id | Integer | Primary key |
| location_id | Integer | FK to locations table |
| target_time | DateTime | Time that was forecasted |
| forecast_issue_time | DateTime | When forecast was made |
| variable | String | Variable being assessed (temp_c, precipitation_probability_pct) |
| forecast_value | Float | Predicted value |
| observed_value | Float | Actual observed value |
| abs_error | Float | Absolute error (|forecast - observed|) |
| pct_error | Float | Percentage error (abs_error / observed * 100) |
| created_at | DateTime | When accuracy record was created |

**Indexes**: 
- `ix_forecast_accuracy_location_target` on (location_id, target_time)

**Usage**: Generated by joining ForecastHourly with ObservationHourly

---

### TrendCache
**Purpose**: Pre-computed trend analysis for common metrics and periods

| Column | Type | Description |
|--------|------|-------------|
| id | Integer | Primary key |
| location_id | Integer | FK to locations table |
| metric | String | Metric name (avg_temp_c, total_precip_mm, etc.) |
| period | String | Analysis period (7d, 30d) |
| current_value | Float | Current period average/total |
| previous_value | Float | Previous period average/total |
| delta | Float | Change (current - previous) |
| pct_change | Float | Percentage change |
| generated_at | DateTime | When trend was computed |

**Indexes**: 
- `ix_trend_cache_unique` on (location_id, metric, period) UNIQUE

**Usage**: Computed by TrendService, supports dashboard displays

---

### AnalyticsQueryAudit
**Purpose**: Track analytics API usage and performance

| Column | Type | Description |
|--------|------|-------------|
| id | Integer | Primary key |
| user_id | Integer | FK to users table (nullable) |
| endpoint | String | Analytics endpoint called |
| params_json | Text | JSON of query parameters |
| duration_ms | Integer | Query execution time |
| rows_returned | Integer | Number of rows returned |
| created_at | DateTime | When query was executed |

**Usage**: Automatic logging for all analytics endpoints

---

## Data Flow

```
Weather Providers → ForecastCache → IngestionService → ForecastHourly
                                                    → ObservationHourly (mock)

ObservationHourly → AggregationService → AggregationDaily

ForecastHourly + ObservationHourly → AccuracyService → ForecastAccuracy

AggregationDaily → TrendService → TrendCache

TrendCache + AggregationDaily + ForecastAccuracy → SummaryPromptService → LLM
```

---

## Performance Considerations

### Current Implementation (Phase 1)
- **Indexes**: Basic indexes on location_id and time columns
- **Aggregations**: Pre-computed daily summaries
- **Trends**: Cached calculations for common periods
- **Queries**: Limited to 14-90 day ranges depending on endpoint

### Future Optimizations (Phase 2+)
- **Partitioning**: Date-based partitioning for large tables
- **Materialized Views**: Pre-computed aggregations at multiple time scales
- **Columnstore**: Consider columnstore indexes for analytical queries
- **Retention Policies**: Automated archival of old raw data
- **Async Processing**: Move aggregation computations to background jobs

---

## Data Quality & Validation

### Current Validations
- Date range limits on API endpoints
- Metric name validation for trends/aggregations
- Required field validation in services

### Planned Improvements
- Data quality metrics in AnalyticsQueryAudit
- Anomaly detection for obviously incorrect values
- Cross-provider data validation
- Missing data gap analysis

---

## Usage Patterns

### Dashboard Queries
- **Recent Data**: Last 7 days of observations and aggregations
- **Trends**: Pre-computed 7d and 30d trends for key metrics
- **Accuracy**: Recent forecast performance summaries

### Batch Processing
- **Daily**: Compute aggregations for previous day
- **Hourly**: Ingest new forecast data
- **Periodic**: Refresh trend calculations

### Analytics Summary
- **On-Demand**: LLM-powered insights combining trends, accuracy, and recent data
- **Structured Input**: Deterministic JSON prevents hallucination

---

## Migration & Evolution

### Alembic Migrations
- `742fe8dc4791_initial_migration_existing_tables.py`: Existing tables
- `24d3fcd30cb4_add_analytics_tables.py`: Analytics tables

### Version Control
- All schema changes through Alembic
- Backward compatibility maintained where possible
- Data migration scripts for major schema changes

### Future Phases
- **Phase 2**: Advanced analytics (anomaly detection, predictive models)
- **Phase 3**: Multi-location comparisons, advanced aggregations
- **Phase 4**: Real-time streaming, high-frequency data

---

## Security & Access

### Current Implementation
- User authentication required for all analytics endpoints
- Location ownership validation (TODO: implement)
- Rate limiting (higher limits for analytics vs standard API)

### Planned Security Features
- Row-level security for multi-tenant scenarios
- Data encryption at rest for sensitive locations
- Audit log retention and compliance features

---

## Monitoring & Observability

### Built-in Metrics
- Query performance (duration_ms in AnalyticsQueryAudit)
- Data freshness (generated_at timestamps)
- Error rates (exception logging)
- Usage patterns (endpoint frequency, parameter analysis)

### Alerting Recommendations
- Data ingestion failures
- Aggregation computation delays
- Unusual query patterns or performance degradation
- Forecast accuracy degradation trends

---

## Related Documentation

- `docs/PROMPTS.md`: LLM template for analytics summaries
- `README.md`: Analytics Platform section
- Backend code: `app/analytics/` module structure